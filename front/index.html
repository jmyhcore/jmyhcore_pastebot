<html>

<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"
        integrity="sha512-aoTNnqZcT8B4AmeCFmiSnDlc4Nj/KPaZyB5G7JnOnUEkdNpCZs1LCankiYi01sLTyWy+m2P+W4XM+BuQ3Q4/Dg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <script src="https://unpkg.com/vue-cookies@1.5.12/vue-cookies.js"></script>


    <style>
        .login-container {
            position: relative;
            height: 1000px;
            box-sizing: border-box;
        }

        .v-centered {
            top: 50%;
            margin-left: auto;
            margin-right: auto;
            width: 24em;
        }

        .border-1px {
            border: 1px collapse
        }
    </style>
</head>

<body>
    <div id="app">
        <v-app>
            <div>
                <div class="login-container" v-if="!token">
                    <v-sheet class="bg-deep-purple pa-12" rounded>
                        <v-card class="mx-auto px-6 py-8" max-width="344">
                            <v-text-field v-model="login" :readonly="loading" :rules="[required]" class="mb-2" clearable
                                label="Login"></v-text-field>

                            <v-text-field v-model="password" :readonly="loading" :rules="[required]" clearable
                                type="password" label="Password" placeholder="Enter your password"></v-text-field>

                            <br>

                            <v-btn :disabled="login && !password" :loading="loading" block color="success" size="large"
                                type="submit" variant="elevated" @click="auth">
                                Sign In
                            </v-btn>
                        </v-card>
                    </v-sheet>
                </div>
            </div>


            <div v-if="token" style="margin-left: auto; margin-right:auto ; width: 50%; margin-top: 25px">
                <v-card class="mx-auto" variant="outlined">
                    <v-card-title>Добавить ПАСТУ</v-card-title>
                    <v-card-text>
                        <v-text-field variant="outlined" label="channel" v-model="currentPasteChannel"></v-text-field>
                        <v-text-field variant="outlined" label="author" v-model="currentPasteAuthor"></v-text-field>
                        <v-text-field variant="outlined" label="weight" v-model="currentPasteWeight"></v-text-field>
                        <v-textarea rows="5" :auto-grow="true" variant="outlined" label="pasta itself"
                            v-model="currentPasteContent"></v-textarea>
                    </v-card-text>
                    <v-card-actions>
                        <v-btn @click="darkTheme = !darkTheme">invert colors</v-btn>
                        <v-spacer></v-spacer>
                        <v-btn @click="submitPaste">давануть</v-btn>
                    </v-card-actions>
                </v-card>

                <div v-if="token" style="margin-left: auto; margin-right:auto ; margin-top: 25px">
                    <v-card class="mx-auto" variant="outlined">
                        <v-card-title>управление</v-card-title>
                        <v-card-text>
                            <v-card v-for="(item, index) in pasteList" :key="index" style="margin-top: 5px">
                                <v-card-title>{{item.author ? item.author : '[no author]'}}</v-card-title>
                                <v-card-subtitle>вес: {{item.weight}} </v-card-subtitle>

                                <div style="width: 35em">
                                    <v-textarea :auto-grow="true" variant="tonal" v-model="item.content"></v-textarea>
                                </div>

                                <v-card-actions>
                                    <v-btn color="error" @click="deletePaste(item, index)">удолить</v-btn>
                                    <v-spacer></v-spacer>
                                    <v-btn @click="update(item, index)">обновить</v-btn>
                                </v-card-actions>
                            </v-card>
                            
                        </v-card-text>
                    </v-card>
                </div>
            </div>
        </v-app>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
</body>
<script>
    vue = new Vue({
        el: '#app',
        vuetify: new Vuetify(),
        data: () => ({
            login: '',
            password: '',
            token: '',
            loading: false,
            currentPasteChannel: 'cptlenivka',
            currentPasteAuthor: 'cptlenivka',
            currentPasteWeight: '1000',
            currentPasteContent: '',
            darkTheme: true,
            pasteList: [{ author: 'template', weight: 0, content: 'template' }],
            pasteListCard: 0
        }),
        methods: {
            required(v) {
                return !!v || 'Field is required'
            },
            async request(uri, body = {}) {
                this.loading = true
                let config = {
                    headers: {
                        'x-access-token': this.token
                    }
                }
                return new Promise(resolve => {
                    axios.post(uri, body, config)
                        .then(response => {
                            this.loading = false
                            resolve(response.data)

                            if (response.data.result == null && response.data.error == 'authorization required') {
                                this.token = ''
                            }
                        })
                })
            },
            async auth() {
                let authdata = await this.request('/login', {
                    login: this.login,
                    pwd: this.password
                })
                this.password = ''

                $cookies.set('login', authdata.login)
                $cookies.set('token', authdata.token)
                this.token = authdata.token
                this.loadPastelist()
            },

            async submitPaste() {
                let body = {
                    channel: this.currentPasteChannel,
                    author: this.currentPasteAuthor,
                    weight: this.currentPasteWeight,
                    content: this.currentPasteContent
                }

                let reply = await this.request('/newpaste', body)
                if (reply.result)  {
                    this.pasteList.push({
                         author: this.currentPasteAuthor,
                         weight: this.currentPasteWeight, 
                         content: this.currentPasteContent,
                         channel: this.currentPasteChannel ? this.currentPasteChannel : null 
                    })   
                    this.currentPasteContent = ''

                }
            },

            async loadPasteList() {
                let reply = await this.request('/pastelist')
                this.pasteList = reply.result
                return reply

            },

            async deletePaste(item, index) {
                let result = await this.request('delete', {id: item.id})
                if (result.result == true) {
                    this.pasteList = this.pasteList.filter( (arrayItem) => {
                        if (item.id != arrayItem.id) return arrayItem
                    })
                }
            },

            async update(item) {
                let result = await this.request('update', {id: item.id, content: item.content})
            }
        },
        watch: {
            darkTheme(newValue, oldValue) {
                if (newValue == oldValue) return
                this.$vuetify.theme = { dark: newValue }
                $cookies.set('theme', newValue ? 1 : 0)
            }
        },
        beforeMount() {
            let token = $cookies.get('token')
            let login = $cookies.get('login')
            if (token && login) {
                this.token = token
                this.login = login
            }

            this.darkTheme = $cookies.get('theme') == 1 ? true : false
            this.$vuetify.theme = { dark: this.darkTheme }
            
        },

        mounted() {
            this.loadPasteList()
        }
    })
    Vue.use(Vuetify, {
        theme: {
            primary: '#C0D8D8',
            secondary: '#D8F0F0',
            accent: '#303030',
            error: '#F72A38',
            warning: '#F5E582',
            info: '#F0F0F0',
            success: '#789078',
        }
    })
</script>

</html>